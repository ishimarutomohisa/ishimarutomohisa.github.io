<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<link rel="icon" href="https://static.wikia.nocookie.net/disneymagicalkingdoms/images/e/ea/Update-16-app_icon.png" type="image/png">
<title>DMK Update</title>
<!-- å¼•å…¥ Font Awesome å›¾æ ‡åº“ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<!-- Highcharts Gantt CDN -->
<script src="https://code.highcharts.com/gantt/highcharts-gantt.js"></script>
<!-- å¼•å…¥æ•°æ®æ–‡ä»¶ -->
<script src="data.js"></script> <!-- ä»»åŠ¡ç¿»è¯‘æ•°æ®åº“ -->
<script src="update.js"></script> <!-- ç‰ˆæœ¬å’Œæ’æœŸé…ç½® -->

<style>
  :root {
    --primary-blue: #1976d2;
    --primary-hover: #1565c0;
    --bg-color: #f0f2f5;
    --card-bg: #ffffff;
    --text-color: #333;
    --border-color: #ddd;
    --scrollbar-width: 8px;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background: var(--bg-color);
    color: var(--text-color);
    overflow-y: auto; 
    padding-bottom: 50px;
  }

  .main-container {
    max-width: 1000px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 30px; 
  }

  .content-card {
    background: var(--card-bg);
    width: 100%;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 24px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
  }

  /* --- æ ‡é¢˜æ  --- */
  h1 {
    display: flex;
    flex-wrap: wrap; 
    align-items: center;
    justify-content: space-between; 
    gap: 12px;
    margin: 0 0 16px 0;
    width: 100%;
  }

  .outline-effect {
    color: #207CE2;
    text-shadow: 1px 1px 0 #fff, 2px 2px 4px rgba(30, 58, 138, 0.3);
    font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
    font-size: clamp(20px, 4vw, 32px);
  }

  .btn-group {
    display: flex;
    gap: 10px;
    align-items: center;
    width: auto; 
    margin: 0;
  }

  .social-btn {
    width: 38px;
    height: 38px;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: #fff;
    cursor: pointer;
    transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    -webkit-tap-highlight-color: transparent;
    outline: none;
    flex: 0 0 auto;
  }

  .social-btn:active { transform: scale(0.9); filter: brightness(0.9); }

  @media (max-width: 768px) {
    h1 { flex-direction: column; align-items: flex-start; }
    .outline-effect { width: 100%; margin-bottom: 5px; }
    .btn-group {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      justify-items: center;
      width: 100%;
      gap: 15px 0;
      height: 60px;
      padding: 12px 0; 
      overflow-y: auto;
      scroll-snap-type: y mandatory; 
      scrollbar-width: none;
    }
    .social-btn { width: 48px; height: 48px; font-size: 22px; scroll-snap-align: center; }
  }

  .btn-patch { background: linear-gradient(rgb(41, 210, 247) 6.16%, rgb(41, 143, 247) 95.06%); }
  .btn-wiki { background-color: #520044; }
  .btn-fb { background-color: #1877F2; }
  .btn-discord { background-color: #5865F2; }
  .btn-github { background-color: #24292e; }
  .btn-reddit { background-color: #FF5700; }

  .note {
    color: #666;
    font-size: 14px;
    margin-bottom: 12px;
    background: #fff8e1;
    padding: 8px 12px;
    border-radius: 4px;
    border-left: 4px solid #ffc107;
    max-height: 100px;       
    overflow-y: auto;        
    white-space: pre-wrap;   
  }

  /* --- Chart --- */
  .chart-section { width: 100%; margin-bottom: 20px; }
  .chart-title {
      font-size: 16px;
      font-weight: bold;
      color: #555;
      margin-bottom: 8px;
      padding-left: 4px;
      border-left: 4px solid var(--primary-blue);
  }

  .chart-wrapper {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border: 1px solid #eee;
    border-radius: 6px;
    background: #fff;
    padding-bottom: 4px;
    touch-action: pan-x; 
    min-height: 200px;
    overscroll-behavior-x: contain;
  }
  
  .chart-wrapper::-webkit-scrollbar { height: 6px; } 
  .chart-wrapper::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
  
  .gantt-container { display: block; }

  /* --- Translator --- */
  .translator-container h2 {
    color: #207CE2;
    text-align: center;
    margin: 0 0 20px 0;
    font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
    text-shadow: 1px 1px 0 #fff, 2px 2px 4px rgba(30, 58, 138, 0.3);
    font-size: 28px;
  }

  .translator-content { display: flex; gap: 20px; flex-wrap: wrap; width: 100%; }
  .translator-box { flex: 1; min-width: 300px; display: flex; flex-direction: column; }
  /* è°ƒæ•´å·¦ä¾§è¾“å…¥æ¡†å®½åº¦ï¼Œç»™è¾“å…¥åŒºæ›´å¤šç©ºé—´ */
.translator-box:first-child {
    flex: 1.2; /* è¾“å…¥æ¡†å  1.2 ä»½ */
}
.translator-box:last-child {
    flex: 2;   /* ç»“æœè¡¨æ ¼å  2 ä»½ï¼Œç¡®ä¿å†…å®¹æ¨ªå‘å±•å¼€ */
}
  .translator-box label { font-weight: bold; margin-bottom: 8px; color: #333; font-size: 16px; }

  .translator-box textarea {
    width: 100%;
    height: 400px;
    padding: 15px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 15px;
    resize: none;
    box-sizing: border-box;
    background-color: #fff;
    line-height: 1.5;
    white-space: pre-wrap;
  }

  .table-wrapper {
    width: 100%;
    height: auto;
    min-height: 400px; 
	max-height: none;  /* å…è®¸æ— é™å‘ä¸‹å»¶ä¼¸ï¼Œä¸äº§ç”Ÿå‚ç›´æ»šåŠ¨æ¡ */
    overflow: auto;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    background-color: #fff;
  }

  .dmk-table { width: 100%; border-collapse: collapse; font-size: 14px; }
  .dmk-table thead th {
    position: sticky; top: 0; background-color: #f8f9fa; color: var(--primary-blue);
    padding: 12px 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #e0e0e0;
    cursor: pointer; z-index: 10; white-space: nowrap; user-select: none;
  }
  .dmk-table thead th:hover { background-color: #e3f2fd; }
  .dmk-table thead th::after { content: 'â†•'; font-size: 12px; margin-left: 5px; opacity: 0.3; }
  .dmk-table thead th.asc::after { content: 'â†‘'; opacity: 1; color: var(--primary-blue); }
  .dmk-table thead th.desc::after { content: 'â†“'; opacity: 1; color: var(--primary-blue); }

  .dmk-table tbody tr { border-bottom: 1px solid #eee; }
  .dmk-table tbody tr:nth-of-type(even) { background-color: #fcfcfc; }
  .dmk-table tbody tr:hover { background-color: #f0f7ff; }
  .dmk-table tbody td { padding: 10px; line-height: 1.4; white-space: nowrap; max-width: 300px; overflow: hidden; text-overflow: ellipsis; }

  .translator-controls { margin: 15px 0 0 0; width: 100%; }
  .generate-btn {
    background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
    color: white; border: none; border-radius: 12px; padding: 15px;
    font-size: 18px; font-weight: bold; cursor: pointer; width: 100%;
    box-shadow: 0 4px 15px rgba(25, 118, 210, 0.4); transition: transform 0.2s;
  }
  .generate-btn:active { transform: translateY(1px); }
  #tableStats { margin-top: 10px; font-size: 13px; color: #666; text-align: right; }

  @media (max-width: 768px) {
    .content-card { padding: 15px; }
    .translator-content { flex-direction: column; gap: 15px; }
    .translator-box textarea, .table-wrapper { min-height: 250px; }
    .table-wrapper { overflow-x: hidden; }
    .dmk-table { font-size: 12px; table-layout: fixed; width: 100%; }
    .dmk-table tbody td { white-space: normal; word-break: break-word; vertical-align: middle; }
    .dmk-table th:nth-child(4), .dmk-table td:nth-child(4),
    .dmk-table th:nth-child(5), .dmk-table td:nth-child(5) { display: none; }
    .dmk-table th:nth-child(1), .dmk-table td:nth-child(1) { width: 25%; padding: 8px 4px; }
    .dmk-table th:nth-child(2), .dmk-table td:nth-child(2) { width: 60%; font-weight: bold; padding: 8px 4px; }
    .dmk-table th:nth-child(3), .dmk-table td:nth-child(3) { width: 15%; text-align: center; padding: 8px 0; white-space: nowrap; }
  }
</style>
</head>
<body>

  <div class="main-container">
    
    <!-- æ¨¡å— 1: æ›´æ–°ä¿¡æ¯å’Œç”˜ç‰¹å›¾ -->
    <div class="content-card">
        <h1>
            <span id="headerTitle" class="outline-effect">DMK Update</span>
            <div class="btn-group">
              <button id="btnPatch" class="social-btn btn-patch" title="Patch Note"><i class="fa-solid fa-file-lines"></i></button>
              <button id="btnWiki" class="social-btn btn-wiki" title="Wiki"><i class="fa-solid fa-book-open"></i></button>
              <button class="social-btn btn-fb" title="Facebook" onclick="window.open('https://www.facebook.com/DisneyMagicKingdoms')"><i class="fa-brands fa-facebook-f"></i></button>
              <button class="social-btn btn-discord" title="Discord" onclick="window.open('https://discord.com/channels/981942496630304818/1288901443511910511')"><i class="fa-brands fa-discord"></i></button>
              <button class="social-btn btn-github" title="Github" onclick="window.open('https://github.com/ishimarutomohisa/ishimarutomohisa.github.io')"><i class="fa-brands fa-github"></i></button>
              <button class="social-btn btn-reddit" title="Reddit" onclick="window.open('https://www.reddit.com/r/disneymagickingdoms/')"><i class="fa-brands fa-reddit-alien"></i></button>
            </div>
        </h1>
        
        <div id="headerNote" class="note" style="display: none;"></div>

        <!-- ç”˜ç‰¹å›¾ 1 (å½“å‰/è¿‡å») -->
        <div id="chartWrapper1" class="chart-section" style="display:none;">
            <div class="chart-title">Current / Recent Schedule</div>
            <div class="chart-wrapper">
                <div id="container1" class="gantt-container"></div>
            </div>
        </div>

        <!-- ç”˜ç‰¹å›¾ 2 (æœªæ¥/æ¥æ¡£) -->
        <div id="chartWrapper2" class="chart-section" style="display:none;">
            <div class="chart-title">Upcoming Schedule</div>
            <div class="chart-wrapper">
                <div id="container2" class="gantt-container"></div>
            </div>
        </div>
    </div>

    <!-- æ¨¡å— 2: ä»»åŠ¡ä¿¡æ¯ç”Ÿæˆå™¨ -->
    <div class="content-card">
        <div class="translator-container">
            <h2>ä»»åŠ¡ä¿¡æ¯ç”Ÿæˆå™¨</h2>
            <div class="translator-content">
              <!-- Input -->
              <div class="translator-box">
                <label for="inputData">è¾“å…¥ä»»åŠ¡åˆ—è¡¨ (æ”¯æŒ è§’è‰²-ä»»åŠ¡ æˆ– ä»»åŠ¡-è§’è‰²)</label>
                <textarea id="inputData" placeholder="ä¾‹å¦‚ï¼š
Pete - Demand Diner Food
Collecting Honey â€“ Kanga (Level 6)"></textarea>
                
                <div class="translator-controls">
                  <button class="generate-btn" onclick="translateTasks()">
                    âœ¨ ç”Ÿæˆä¿¡æ¯ âœ¨
                  </button>
                </div>
              </div>
              
              <!-- Output -->
              <div class="translator-box">
                <label>ç”Ÿæˆç»“æœ (ç‚¹å‡»è¡¨å¤´æ’åº)</label>
                <div class="table-wrapper" id="resultTableContainer">
                  <table class="dmk-table" id="resultTable">
                    <thead>
                      <tr>
                        <th onclick="sortTable(0)">è§’è‰²</th>
                        <th onclick="sortTable(1)">ä»»åŠ¡</th>
                        <th onclick="sortTable(2)">æ—¶é•¿</th>
                        <th onclick="sortTable(3)">å»ºç­‘</th>
                        <th onclick="sortTable(4)">å…¶ä»–</th>
                      </tr>
                    </thead>
                    <tbody id="tableBody">
                      <tr><td colspan="5" style="text-align:center; color:#999; padding:20px;">ç­‰å¾…ç”Ÿæˆæ•°æ®...</td></tr>
                    </tbody>
                  </table>
                </div>
                <div id="tableStats"></div>
              </div>
            </div>
        </div>
    </div>

  </div>

<script>
// ==========================================
// 1. GLOBAL CONFIG & INITIALIZATION
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
  if (typeof CONFIG === 'undefined') {
    alert("é”™è¯¯ï¼šæœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ update.js");
    return;
  }
  
  // Set Title
  const headerTitle = document.getElementById('headerTitle');
  if(headerTitle) headerTitle.innerText = `DMK Update ${CONFIG.version}`;
  
  // Set Note
  const noteEl = document.getElementById('headerNote');
  if (noteEl) {
    if (CONFIG.note && CONFIG.note.trim() !== '') {
      noteEl.innerHTML = CONFIG.note; 
      noteEl.style.display = 'block'; 
    } else {
      noteEl.style.display = 'none';
    }
  }
  
  // Buttons
  const btnPatch = document.getElementById('btnPatch');
  if(btnPatch) btnPatch.onclick = () => window.open(`https://www.disney-magic-kingdoms.com/news/patchnote_upd${CONFIG.version.split('+')[0].trim()}`);
  
  const btnWiki = document.getElementById('btnWiki');
  if(btnWiki) btnWiki.onclick = () => window.open(`https://dmk.fandom.com/wiki/Category:Update_${CONFIG.version.split('+')[0].trim()}`);

  // Init Tasks DB
  initDatabase();
});

// ==========================================
// 2. DYNAMIC GANTT CHART LOGIC
// ==========================================
(function() {
  
  // å®šä¹‰é€šç”¨æ¸²æŸ“å‡½æ•°
  // å®šä¹‰é€šç”¨æ¸²æŸ“å‡½æ•°
  function renderGanttChart(containerId, scheduleData, specialDatesData) {
      if (!scheduleData || scheduleData.length === 0) return null;

      const colors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336', '#3F51B5', '#00BCD4'];
      const nowMs = Date.now() + 8*3600*1000; 

      // è¾…åŠ©å‡½æ•°ï¼šè½¬æ¢ä¸ºUTCæ—¶é—´æˆ³ (23:00)
      function toUtcMs(ymd) {
        const parts = ymd.split('-').map(Number);
        return Date.UTC(parts[0], parts[1]-1, parts[2], 23); 
      }

      // ==========================================
      // [æ–°å¢] 1. å¤–éƒ¨æ’åºï¼šå¯¹ Group è¿›è¡Œæ’åº
      // ==========================================
      // é€»è¾‘ï¼šæ‰¾å‡ºæ¯ä¸ªç»„å†…æœ€æ—©çš„ä¸€ä¸ªä»»åŠ¡æ—¶é—´ï¼ŒæŒ‰è¿™ä¸ªæ—¶é—´å¯¹æ¯”ï¼Œå†³å®šç»„çš„é¡ºåº
      scheduleData.sort((groupA, groupB) => {
          // è·å–ç»„ A ä¸­æœ€æ—©çš„ä»»åŠ¡å¼€å§‹æ—¶é—´
          const minA = groupA.tasks && groupA.tasks.length > 0 
              ? Math.min(...groupA.tasks.map(t => toUtcMs(t.start))) 
              : Infinity; // å¦‚æœæ²¡æœ‰ä»»åŠ¡ï¼Œæ’åˆ°æœ€å

          // è·å–ç»„ B ä¸­æœ€æ—©çš„ä»»åŠ¡å¼€å§‹æ—¶é—´
          const minB = groupB.tasks && groupB.tasks.length > 0 
              ? Math.min(...groupB.tasks.map(t => toUtcMs(t.start))) 
              : Infinity;

          return minA - minB; // å‡åºæ’åˆ—
      });

      const seriesData = [];
      const categories = [];
      const plotBands = [];
      let yIndex = 0;
      let colorIdx = 0;

      scheduleData.forEach((group, gIdx) => {
        // [ä¿ç•™] 2. å†…éƒ¨æ’åºï¼šå¯¹ Group å†…çš„ Task è¿›è¡Œæ’åº
        const tasks = group.tasks.sort((a,b) => toUtcMs(a.start) - toUtcMs(b.start));
        
        const lanes = [];
        
        tasks.forEach(task => {
          const start = toUtcMs(task.start); 
          const end = toUtcMs(task.end);
          let placed = false;
          
          for(let lane of lanes) {
            if(start >= lane[lane.length-1].end) { 
              lane.push({ ...task, start, end });
              placed = true;
              break;
            }
          }
          if(!placed) lanes.push([{ ...task, start, end }]);
        });

        const startY = yIndex;
        lanes.forEach((lane, lIdx) => {
          categories.push(lIdx === 0 ? group.resource : '');
          lane.forEach(t => {
            seriesData.push({
              id: `${group.resource}_${t.label}_${Math.random()}`,
              name: t.label,
              start: t.start,
              end: t.end,
              y: yIndex,
              color: colors[colorIdx++ % colors.length]
            });
          });
          yIndex++;
        });

        plotBands.push({
          from: startY - 0.5,
          to: yIndex - 0.5,
          color: gIdx % 2 === 0 ? 'rgba(250,250,250,0.9)' : 'rgba(245,245,255,0.95)'
        });
      });

      // Plot Lines
      const finalPlotLines = [];
      finalPlotLines.push({
        value: nowMs,
        color: '#FF3B30',
        width: 2,
        dashStyle: 'ShortDash',
        zIndex: 3,
        label: { rotation: 0, x: 9, y: -4, text: 'ï¸ğŸ”»', align: 'right', style: { color: '#FF3B30' } }
      });

      // å¯»æ‰¾æœ€æ—©çš„ç‰¹æ®Šæ—¥æœŸ
      let minSpecialDateMs = null; 

      if (specialDatesData && Array.isArray(specialDatesData)) {
        specialDatesData.forEach(item => {
          const sDateMs = toUtcMs(item.date);
          if (minSpecialDateMs === null || sDateMs < minSpecialDateMs) {
              minSpecialDateMs = sDateMs;
          }
          finalPlotLines.push({
            value: sDateMs,
            color: item.color || '#30C2FF',
            width: 2,
            dashStyle: 'ShortDash',
            zIndex: 2,
            label: { 
              rotation: 0, x: 9, y: -4, 
              text: item.label, 
              align: 'right',
			  allowOverlap: true, // [æ–°å¢] å¼ºåˆ¶å…è®¸é‡å 
              style: { 
				color: item.color || '#30C2FF',
				opacity: 1 // [æ–°å¢] å¼ºåˆ¶é€æ˜åº¦ä¸º 1
			  } 
            }
          });
        });
      }

      // è®¡ç®— X è½´èµ·æ­¢æ—¶é—´
      const minTaskStartMs = seriesData.length > 0 ? Math.min(...seriesData.map(d => d.start)) : Date.now();
      
      let absoluteMinMs = minTaskStartMs;
      if (minSpecialDateMs !== null && minSpecialDateMs < minTaskStartMs) {
          absoluteMinMs = minSpecialDateMs;
      }

      // å‘å‰é¢„ç•™ 1 å¤©
      const xAxisMin = absoluteMinMs - (1 * 24 * 3600 * 1000);

      const maxEndMs = seriesData.length > 0 ? Math.max(...seriesData.map(d => d.end)) : (nowMs + 86400000);

      const container = document.getElementById(containerId);
      const screenWidth = window.innerWidth;
      const isDesktop = screenWidth >= 1000;

      if (isDesktop) {
          container.style.width = '100%'; 
      } else {
          const totalDays = Math.ceil((maxEndMs - xAxisMin) / (24 * 3600 * 1000));
          const pxPerDay = 25; 
          const wrapperWidth = container.parentElement.clientWidth || screenWidth;
          const finalWidth = Math.max(wrapperWidth, totalDays * pxPerDay);
          container.style.width = `${finalWidth}px`; 
      }

      Highcharts.ganttChart(containerId, {
        chart: { 
          height: Math.max(200, categories.length * 30 + 50), 
          style: { fontFamily: 'inherit' } 
        },
        title: { text: undefined },
        xAxis: [{
          grid: { enabled: true },
          tickInterval: 24 * 3600 * 1000,
          labels: { format: '{value:%d}', style: { fontSize: '11px' } },
          min: xAxisMin,
          max: maxEndMs,
          plotLines: finalPlotLines 
        }],
        yAxis: { 
          categories, 
          reversed: true, 
          grid: { enabled: true }, 
          labels: { enabled: false }, 
          plotBands 
        },
        series: [{ 
          name: 'Tasks', 
          data: seriesData, 
          dataLabels: { 
            enabled: true, 
            format: '{point.name}', 
            style: { 
                color: 'white', 
                textOutline: '2px contrast', 
                fontWeight: 'normal', 
                fontSize: '11px',
                whiteSpace: isDesktop ? 'normal' : 'nowrap' 
            } 
          },
          borderWidth: 0
        }],
        tooltip: { enabled: false },
        credits: { enabled: false }
      });

      if (!isDesktop) {
          setTimeout(() => {
              const chartDiv = container.parentElement;
              let targetMs = nowMs;
              if (targetMs < xAxisMin) targetMs = xAxisMin; 
              if (targetMs > maxEndMs) targetMs = maxEndMs;

              const totalMs = maxEndMs - xAxisMin;
              const percent = (targetMs - xAxisMin) / totalMs;
              const currentWidth = parseInt(container.style.width); 
              const wrapperW = chartDiv.clientWidth;
              const scrollPos = (percent * currentWidth) - (wrapperW / 2);
              if(chartDiv && scrollPos > 0) chartDiv.scrollLeft = scrollPos;
          }, 500);
      }
      
      return maxEndMs; 
  }

document.addEventListener('DOMContentLoaded', () => {
    // 1. è·å–åŸºç¡€æ•°æ®
    const hasSch1 = typeof schedules !== 'undefined' && schedules.length > 0;
    const hasSch2 = typeof schedules2 !== 'undefined' && schedules2.length > 0;
    const sDates1 = typeof specialDates !== 'undefined' ? specialDates : [];
    const sDates2 = typeof specialDates2 !== 'undefined' ? specialDates2 : [];
    
    // è·å–ä»Šå¤©å‡Œæ™¨çš„æ—¶é—´æˆ³ï¼Œç”¨äºè¿‡æœŸåˆ¤æ–­
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayTs = today.getTime();

    // 2. è¾…åŠ©å‡½æ•°ï¼šè·å–æ—¶é—´èŒƒå›´åŠåˆ¤æ–­æ˜¯å¦è¿‡æœŸ
    function getSchInfo(schedule) {
        if (!schedule || schedule.length === 0) return { minStart: Infinity, maxEnd: 0, isExpired: true };
        
        let minStart = Infinity;
        let maxEnd = 0;

        schedule.forEach(group => {
            group.tasks.forEach(t => {
                const sParts = t.start.split('-').map(Number);
                const eParts = t.end.split('-').map(Number);
                // ä½¿ç”¨ UTC æˆ–å½“åœ°æ—¶é—´ä¿æŒä¸€è‡´ï¼Œè¿™é‡Œå»ºè®®ä¸ renderGanttChart ä¿æŒä¸€è‡´
                const sTs = Date.UTC(sParts[0], sParts[1] - 1, sParts[2], 23);
                const eTs = Date.UTC(eParts[0], eParts[1] - 1, eParts[2], 23);

                if (sTs < minStart) minStart = sTs;
                if (eTs > maxEnd) maxEnd = eTs;
            });
        });

        // å¦‚æœè¯¥å›¾è¡¨æœ€æ™šçš„ä»»åŠ¡ç»“æŸæ—¶é—´æ¯”ä»Šå¤©è¿˜æ—©ï¼Œåˆ¤å®šä¸ºè¿‡æœŸ
        const isExpired = maxEnd < Date.now(); 

        return { minStart, maxEnd, isExpired };
    }

    // 3. å†³å®šæ˜¾ç¤ºé¡ºåºå¹¶è¿‡æ»¤è¿‡æœŸå›¾è¡¨
    let displayList = [];
    
    if (hasSch1) {
        const info1 = getSchInfo(schedules);
        // åªæœ‰æ²¡è¿‡æœŸæ‰åŠ å…¥æ˜¾ç¤ºåˆ—è¡¨
        if (!info1.isExpired) {
            displayList.push({ id: 1, sch: schedules, dates: sDates1, minStart: info1.minStart });
        }
    }
    
    if (hasSch2) {
        const info2 = getSchInfo(schedules2);
        if (!info2.isExpired) {
            displayList.push({ id: 2, sch: schedules2, dates: sDates2, minStart: info2.minStart });
        }
    }

    // 4. æŒ‰æ—¶é—´å…ˆåæ’åº
    displayList.sort((a, b) => a.minStart - b.minStart);

    // 5. æ‰§è¡Œæ¸²æŸ“
    const mainContainer = document.getElementById('chartWrapper1').parentElement; 
    
    // å…ˆå…¨éƒ¨éšè—ï¼Œåé¢æŒ‰éœ€å¼€å¯
    document.getElementById('chartWrapper1').style.display = 'none';
    document.getElementById('chartWrapper2').style.display = 'none';

    displayList.forEach((item, index) => {
        const wrapperId = `chartWrapper${item.id}`;
        const containerId = `container${item.id}`;
        const wrapperEl = document.getElementById(wrapperId);
        
        if (wrapperEl) {
            wrapperEl.style.display = 'block';
            mainContainer.appendChild(wrapperEl); 

            const titleEl = wrapperEl.querySelector('.chart-title');
            if (displayList.length === 1) {
                titleEl.style.display = 'none'; // åªæœ‰ä¸€ä¸ªå›¾æ—¶éšè—æ ‡é¢˜
            } else {
                titleEl.style.display = 'block';
                titleEl.innerText = index === 0 ? "Current Schedule" : "Upcoming Schedule";
            }

            renderGanttChart(containerId, item.sch, item.dates);
        }
    });
});
})();

// ==========================================
// 3. TRANSLATOR LOGIC
// ==========================================
let taskDatabase = [];
let currentTableData = [];
let sortDirection = {};

function initDatabase() {
  try {
    if (typeof rawDataSource === 'undefined') {
      console.error("rawDataSource is undefined.");
      document.querySelector('#tableBody').innerHTML = '<tr><td colspan="5" style="color:red;text-align:center;">é”™è¯¯ï¼šæœªæ‰¾åˆ°æ•°æ®æº (data.js)</td></tr>';
      return;
    }
    let clean = rawDataSource.replace(/--\[=\[[\s\S]*?--\]=\]/g, '').replace(/--.*/g, '').replace(/^return\s*\{/, '').replace(/\}\s*$/, '').trim();
    const rowMatches = clean.match(/\{[^}]+\}/g);
    if (rowMatches) {
        taskDatabase = rowMatches.map(rowStr => {
            const content = rowStr.slice(1, -1);
            const parts = [];
            let current = '';
            let inQuote = false;
            for(let char of content) {
                if(char === '"') { inQuote = !inQuote; continue; }
                if(char === ',' && !inQuote) { parts.push(current.trim()); current = ''; } 
                else { current += char; }
            }
            parts.push(current.trim());
            return parts;
        });
        console.log(`Database loaded: ${taskDatabase.length} entries.`);
    }
  } catch (e) {
    console.error("Data parse error", e);
  }
}

function findTask(line) {
    const input = line.trim();
    if (!input) return null;
    const separators = [' - ', ' â€“ ', ' â€” ', '-', 'â€“'];
    let charName = '', taskName = input;
    
    for (const sep of separators) {
        if (input.includes(sep)) {
            let parts = input.split(sep);
            let p1 = parts[0].trim();
            let p2 = parts.slice(1).join(sep).trim();
            
            // --- æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœæ˜¯ "ä»»åŠ¡ - è§’è‰²(ç­‰çº§)" æ ¼å¼ ---
            if (p2.includes('(') && p2.includes(')')) {
                charName = p2.split('(')[0].trim(); // æå–æ‹¬å·å‰çš„åå­—
                taskName = p1;
            } else {
                charName = p1;
                taskName = p2;
            }
            break;
        }
    }

    const normTask = taskName.toLowerCase().replace(/['"â€™]/g, "");
    const normChar = charName.toLowerCase().replace(/['"â€™]/g, "");
    
    // --- ä»¥ä¸‹é€»è¾‘ä¿æŒå®Œå…¨ä¸å˜ ---
    const isKeywordMatch = (inputStr, targetStr) => {
        const getWords = (s) => s.split(/\s+/).filter(w => w.length > 0);
        const inputWords = getWords(inputStr);
        const targetWords = getWords(targetStr);
        if (inputWords.length === 0 || targetWords.length === 0) return false;
        return inputWords.every(word => targetStr.includes(word)) || targetWords.every(word => inputStr.includes(word));
    };

    const getEditDistance = (a, b) => {
        if(a.length === 0) return b.length;
        if(b.length === 0) return a.length;
        const matrix = [];
        for(let i = 0; i <= b.length; i++) matrix[i] = [i];
        for(let j = 0; j <= a.length; j++) matrix[0][j] = j;
        for(let i = 1; i <= b.length; i++){
            for(let j = 1; j <= a.length; j++){
                if(b.charAt(i-1) === a.charAt(j-1)) matrix[i][j] = matrix[i-1][j-1];
                else matrix[i][j] = Math.min(matrix[i-1][j-1] + 1, Math.min(matrix[i][j-1] + 1, matrix[i-1][j] + 1));
            }
        }
        return matrix[b.length][a.length];
    };

    const isTypoMatch = (inputStr, targetStr) => {
        if (Math.abs(inputStr.length - targetStr.length) > 3) return false;
        const dist = getEditDistance(inputStr, targetStr);
        const maxLength = Math.max(inputStr.length, targetStr.length);
        return (1 - dist / maxLength) >= 0.8;
    };

    if (charName) {
        const charTasks = taskDatabase.filter(row => row[0].toLowerCase() === normChar);
        if (charTasks.length > 0) {
            const exact = charTasks.find(row => row[4].toLowerCase().replace(/['"â€™]/g, "") === normTask);
            if (exact) return { data: exact, type: 'Exact' };
            const fuzzy = charTasks.find(row => row[4].toLowerCase().replace(/['"â€™]/g, "").includes(normTask) || normTask.includes(row[4].toLowerCase().replace(/['"â€™]/g, "")));
            if (fuzzy) return { data: fuzzy, type: 'Fuzzy' };
            const keywordMatch = charTasks.find(row => isKeywordMatch(normTask, row[4].toLowerCase().replace(/['"â€™]/g, "")));
            if (keywordMatch) return { data: keywordMatch, type: 'Keyword' };
            const typoMatch = charTasks.find(row => isTypoMatch(normTask, row[4].toLowerCase().replace(/['"â€™]/g, "")));
            if (typoMatch) return { data: typoMatch, type: 'Typo' };
        }
    }

    const globalMatch = taskDatabase.find(row => row[4].toLowerCase().replace(/['"â€™]/g, "") === normTask);
    if (globalMatch) return { data: globalMatch, type: 'Global Exact' };

    if (normTask.length > 3) { 
        const globalKeyword = taskDatabase.find(row => isKeywordMatch(normTask, row[4].toLowerCase().replace(/['"â€™]/g, "")));
        if (globalKeyword) return { data: globalKeyword, type: 'Global Keyword' };
        if (normTask.length > 6) {
            const globalTypo = taskDatabase.find(row => isTypoMatch(normTask, row[4].toLowerCase().replace(/['"â€™]/g, "")));
            if (globalTypo) return { data: globalTypo, type: 'Global Typo' };
        }
    }
    return null;
}

function translateTasks() {
    const input = document.getElementById('inputData').value;
    const lines = input.split('\n').filter(l => l.trim());
    currentTableData = [];
    let found = 0, notFound = 0;
    if (taskDatabase.length === 0) initDatabase();

    lines.forEach(line => {
        const res = findTask(line);
        if (res) {
            found++;
            const d = res.data;
            let charStr = `${d[0]} (Lv.${d[1]})`;
            if (d[2]) charStr += ` + ${d[2]} (Lv.${d[3]})`;
            let extras = [];
            if(d[7] && d[7] !== "") extras.push(`Drop: ${d[7]}`); 
            if(d[8] && !d[8].includes("Coming Soon")) extras.push(d[8]);

            currentTableData.push({
                char: charStr, task: d[4], time: d[5], timeVal: parseDuration(d[5]), build: d[6], extra: extras.join(', ')
            });
        } else {
            notFound++;
            currentTableData.push({
                char: line.split(/[-â€“]/)[0].trim() || 'Unknown', task: line, time: '-', timeVal: 0, build: '-', extra: 'Not Found'
            });
        }
    });
    renderTable();
	document.getElementById('tableStats').innerHTML = `<span style="margin-right:15px">âœ… Found: <b>${found}</b></span><span style="color:#e53e3e">âŒ Missing: <b>${notFound}</b></span>`;
}

function parseDuration(str) {
    if(!str || str === '-') return 0;
    str = str.toLowerCase();
    if(str.includes('h')) return parseFloat(str) * 60;
    if(str.includes('m')) return parseFloat(str);
    if(str.includes('s')) return parseFloat(str) / 60;
    return 0;
}

function renderTable() {
    const tbody = document.getElementById('tableBody');
    if (currentTableData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px">æ— æ•°æ®</td></tr>';
        return;
    }
    tbody.innerHTML = currentTableData.map(row => `
        <tr><td title="${row.char}">${row.char}</td><td title="${row.task}">${row.task}</td><td>${row.time}</td><td title="${row.build}">${row.build}</td><td title="${row.extra}">${row.extra}</td></tr>
    `).join('');
}

function sortTable(colIndex) {
    const keys = ['char', 'task', 'timeVal', 'build', 'extra'];
    const key = keys[colIndex];
    sortDirection[colIndex] = !sortDirection[colIndex];
    const isAsc = sortDirection[colIndex];
    document.querySelectorAll('th').forEach((th, idx) => {
        th.classList.remove('asc', 'desc');
        if(idx === colIndex) th.classList.add(isAsc ? 'asc' : 'desc');
    });
    currentTableData.sort((a, b) => {
        let valA = a[key]; let valB = b[key];
        if (typeof valA === 'string') valA = valA.toLowerCase();
        if (typeof valB === 'string') valB = valB.toLowerCase();
        if (valA < valB) return isAsc ? -1 : 1;
        if (valA > valB) return isAsc ? 1 : -1;
        return 0;
    });
    renderTable();
}

window.translateTasks = translateTasks;
window.sortTable = sortTable;
</script>
</body>
</html>
