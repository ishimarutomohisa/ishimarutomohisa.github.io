<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMKé‡‘æ¯èµ› - ä¸‡èƒ½é€‚é…åŒæ­¥å™¨</title>
	<script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/leancloud-storage/4.12.0/av-min.js"></script>
    <style>
        :root { --primary: #6200ee; --secondary: #03dac6; --my-choice: #ff9800; }
        body { font-family: -apple-system, system-ui, sans-serif; background: #f4f7f9; margin: 0; padding: 15px; }
        .card { background: white; max-width: 480px; margin: auto; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); padding: 24px; }
        .status-tag { display: inline-block; padding: 5px 14px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-bottom: 15px; }
        .status-open { background: #e3f2fd; color: #1976d2; }
        .status-closed { background: #ffebee; color: #d32f2f; }
        
        .my-record { background: #fff8e1; border-left: 5px solid var(--my-choice); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; box-shadow: inset 0 0 5px rgba(0,0,0,0.02); }
        .my-record b { color: #f57c00; }

        .input-group { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        input { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; margin: 10px 0; box-sizing: border-box; font-size: 16px; outline: none; transition: border-color 0.3s; }
        input:focus { border-color: var(--primary); }
        
        .best-time-banner { background: linear-gradient(135deg, var(--primary), #3700b3); color: white; padding: 25px; border-radius: 15px; text-align: center; margin-bottom: 25px; }
        .best-time-banner strong { font-size: 3rem; display: block; line-height: 1; margin: 10px 0; letter-spacing: -1px; }

        .timeline { display: flex; align-items: flex-end; height: 100px; gap: 2px; margin: 20px 0; border-bottom: 2px solid #eee; }
        .time-bar { flex: 1; background: #eee; border-radius: 3px 3px 0 0; position: relative; min-height: 2px; }
        .time-bar.active { background: var(--secondary); }
        .time-bar.is-mine { background: var(--my-choice); box-shadow: 0 0 4px rgba(255,152,0,0.5); }
        
        .btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
		.btn:disabled {
    background: #ccc;           /* ç°è‰²èƒŒæ™¯ */
    cursor: not-allowed;        /* ç¦ç”¨å…‰æ ‡ */
    transform: none !important; /* å–æ¶ˆç‚¹å‡»ç¼©æ”¾æ•ˆæœ */
    color: #666;
}
        .hint { font-size: 12px; color: #888; line-height: 1.6; background: #fdfdfd; padding: 10px; border-radius: 6px; }
    </style>
</head>
<body>

<div class="card">
    <div id="deadlineTag" class="status-tag status-open">åŒæ­¥ç»Ÿè®¡ä¸­</div>
    
    <div class="best-time-banner">
        <span style="font-size: 14px; opacity: 0.9;">å…¨å‘˜å…±è¯†æœ€ä½³å…¥åœºç‚¹</span>
        <strong id="finalTime">--:--</strong>
        <span id="totalStats">ç­‰å¾…æ•°æ®...</span>
    </div>

    <div id="myRecordBox" class="my-record" style="display: none;">
        ğŸ™‹ <b>æˆ‘çš„å½“å‰æ—¶æ®µï¼š</b><br>
        <span id="myCurrentSelection">å°šæœªæäº¤</span>
    </div>

    <div id="inputArea">
        <div class="input-group">
            <label style="font-weight: bold; font-size: 14px; color: #444;">æ›´æ–°æˆ‘çš„å¯ç”¨æ—¶é—´ï¼š</label>
            <input type="text" id="timeInput" placeholder="ä¾‹: 10:00-10:10, 12:00-12:30">
            <div class="hint">
    âœ… <b>å·²å¼€å¯å…¨å…¼å®¹è¯†åˆ«ï¼š</b><br>
    â€¢ æ”¯æŒå•ä¸ªæ—¶é—´ç‚¹ (å¦‚ <code>20:05</code>)<br>
    â€¢ æ”¯æŒæ—¶æ®µ (å¦‚ <code>20:00-20:10</code>)<br>
    â€¢ è‡ªåŠ¨è¯†åˆ«ä¸­è‹±æ–‡å†’å·ã€é€—å·å’Œç©ºæ ¼
</div>
        </div>
        <button id="submitBtn" class="btn" onclick="submitData()">æäº¤å¹¶åˆ·æ–°ç»Ÿè®¡</button>
    </div>

    <div style="margin-top: 30px; font-size: 14px; font-weight: bold; color: #333;">åˆ†é’Ÿçƒ­åº¦è¶‹åŠ¿ (æ©™è‰²ä¸ºä½ è¦†ç›–çš„ç‚¹)ï¼š</div>
    <div id="timeline" class="timeline"></div>
</div>

<script>
    // --- è¯·åœ¨æ­¤é…ç½®æ‚¨çš„ LeanCloud ä¿¡æ¯ ---
    const CONFIG = {
        APP_ID: '0c2sNjTnLZPcSDYXu6MvDM0O-MdYXbMMI',
        APP_KEY: 'cTljOeagmHnNescs0ee5jURr',
        SERVER_URL: 'https://0c2snjtn.api.lncldglobal.com',
        DEADLINE: new Date('2025-12-20T16:50:00') 
    };

    AV.init({ appId: CONFIG.APP_ID, appKey: CONFIG.APP_KEY, serverURL: CONFIG.SERVER_URL });
    const Vote = AV.Object.extend('MinuteVote');
    let userIP = '';
    let mySelectedMinutes = [];

	async function init() {
		try {
			// ä½¿ç”¨ç½‘æ˜“çš„å›½å†…é•œåƒæ¥å£ï¼ŒåŠ è½½é€Ÿåº¦æå¿«
			const resp = await fetch('https://api.ip.sb/ip'); 
			// å¦‚æœä¸Šé¢é‚£ä¸ªä¸è¡Œï¼Œå¤‡é€‰ï¼šhttps://vv.video.qq.com/checktime?otype=json
			
			const text = await resp.text();
			userIP = text.trim(); // è·å–çº¯æ–‡æœ¬å½¢å¼çš„ IP
			
			console.log("è¯†åˆ«åˆ°ç©å®¶IP:", userIP);

			checkDeadline();
			await loadAllData();
		} catch (e) {
			console.error("IPè·å–å¤±è´¥ï¼Œå°è¯•åŒ¿ååŠ è½½", e);
			// å¦‚æœIPæ¥å£ä¹ŸæŒ‚äº†ï¼Œä¸ºäº†ä¸å½±å“ä½¿ç”¨ï¼Œç»™ä¸€ä¸ªé»˜è®¤æ ‡è¯†
			userIP = 'anonymous'; 
			checkDeadline();
			await loadAllData();
		}
	}

    function checkDeadline() {
        if (new Date() > CONFIG.DEADLINE) {
            document.getElementById('deadlineTag').innerText = "ç»Ÿè®¡å·²æˆªæ­¢";
            document.getElementById('deadlineTag').className = "status-tag status-closed";
            document.getElementById('inputArea').style.display = 'none';
            return true;
        }
        return false;
    }

    async function loadAllData() {
        const query = new AV.Query('MinuteVote');
        query.limit(1000);
        const results = await query.find();

        const stats = {};
        mySelectedMinutes = [];

        results.forEach(r => {
            const slots = r.get('choice') || [];
            if (r.get('ip') === userIP) {
                mySelectedMinutes = slots;
                document.getElementById('myRecordBox').style.display = 'block';
                document.getElementById('myCurrentSelection').innerText = r.get('rawInput');
                document.getElementById('timeInput').value = r.get('rawInput');
            }
            slots.forEach(m => { stats[m] = (stats[m] || 0) + 1; });
        });

        calculateBest(stats, results.length);
    }

    function calculateBest(stats, total) {
        let max = 0, bestM = -1;
        Object.keys(stats).forEach(m => {
            if (stats[m] > max) { max = stats[m]; bestM = m; }
        });

        document.getElementById('finalTime').innerText = bestM !== -1 ? minToTime(bestM) : "--:--";
        document.getElementById('totalStats').innerText = `å·²æ±‡èš ${total} ä½ç©å®¶æ„å‘`;
        renderChart(stats, max);
    }

    function renderChart(stats, max) {
        const container = document.getElementById('timeline');
        container.innerHTML = '';
        const keys = Object.keys(stats).map(Number).sort((a,b) => a-b);
        if (keys.length === 0) return;

        // åŠ¨æ€èŒƒå›´ï¼šåªæ˜¾ç¤ºæœ‰æ•°æ®çš„æ—¶æ®µå‰åæ‰©å±• 5 åˆ†é’Ÿ
        const start = keys[0] - 5;
        const end = keys[keys.length - 1] + 5;

        for (let i = start; i <= end; i++) {
            const count = stats[i] || 0;
            const bar = document.createElement('div');
            bar.className = 'time-bar';
            if (count > 0) bar.classList.add('active');
            if (mySelectedMinutes.includes(i)) bar.classList.add('is-mine');
            
            bar.style.height = max > 0 ? `${Math.max((count / max) * 100, 2)}%` : '2%';
            bar.title = `${minToTime(i)}: ${count}äºº`;
            container.appendChild(bar);
        }
    }

	async function submitData() {
		if (checkDeadline()) return;
		
		const btn = document.getElementById('submitBtn');
		const raw = document.getElementById('timeInput').value;
		const minutes = parseToMinutes(raw);
		
		if (minutes.length === 0) return alert("æœªèƒ½è¯†åˆ«æœ‰æ•ˆæ—¶é—´ï¼Œè¯·æ£€æŸ¥æ ¼å¼ (ä¾‹ 10:00-10:10)");

		// --- å¼€å¯å†·å´é”å®š ---
		btn.disabled = true;
		const originalText = btn.innerText;
		
		try {
			const query = new AV.Query('MinuteVote');
			query.equalTo('ip', userIP);
			let obj = await query.first() || new Vote();
			
			obj.set('ip', userIP);
			obj.set('choice', minutes);
			obj.set('rawInput', raw);
			await obj.save();
			
			alert("æäº¤æˆåŠŸï¼");
			await loadAllData(); // æäº¤æˆåŠŸååˆ·æ–°æ•°æ®
			
			// æˆåŠŸåå¼€å§‹ 30 ç§’å€’è®¡æ—¶
			startCooldown(btn, 30, originalText);

		} catch (e) {
			console.error(e);
			alert("æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•");
			// å¤±è´¥æ—¶ç«‹å³æ¢å¤æŒ‰é’®ï¼Œå…è®¸é‡è¯•
			btn.disabled = false;
			btn.innerText = originalText;
		}
	}

	// æ–°å¢å€’è®¡æ—¶é€»è¾‘å‡½æ•°
	function startCooldown(btn, seconds, text) {
		let timeLeft = seconds;
		
		const timer = setInterval(() => {
			if (timeLeft <= 0) {
				clearInterval(timer);
				btn.disabled = false;
				btn.innerText = text;
			} else {
				btn.innerText = `å·²æäº¤ (å†·å´ä¸­ ${timeLeft}s)`;
				timeLeft--;
			}
		}, 1000);
	}

	function parseToMinutes(str) {
		const result = new Set();
		// 1. ç»Ÿä¸€åˆ†éš”ç¬¦ï¼šå°†ä¸­æ–‡é€—å·ã€åˆ†å·ã€ç©ºæ ¼å…¨éƒ¨è½¬ä¸ºè‹±æ–‡é€—å·
		// 2. æŒ‰é€—å·åˆ†å‰²ï¼Œå¹¶è¿‡æ»¤æ‰ç©ºé¡¹
		const parts = str.replace(/[ï¼Œï¼›; ]/g, ',').split(',').filter(p => p.trim());

		parts.forEach(p => {
			// 3. ç»Ÿä¸€å†’å·å’Œè¿æ¥ç¬¦ï¼šå°†ä¸­æ–‡å†’å·è½¬ä¸ºè‹±æ–‡ï¼Œä¸­æ–‡æ³¢æµªçº¿ç­‰è½¬ä¸ºæ ‡å‡†æ¨ªæ 
			const cleanPart = p.trim().replace(/ï¼š/g, ':').replace(/[~ï½â€”]/g, '-');
			
			if (cleanPart.includes('-')) {
				// å¤„ç†æ—¶é—´æ®µï¼šä¾‹å¦‚ 10:00-10:10
				const range = cleanPart.split('-');
				if (range.length === 2) {
					const s = timeToMin(range[0].trim());
					const e = timeToMin(range[1].trim());
					if (!isNaN(s) && !isNaN(e)) {
						for (let i = Math.min(s, e); i <= Math.max(s, e); i++) result.add(i);
					}
				}
			} else {
				// å¤„ç†å•ä¸ªæ—¶é—´ç‚¹ï¼šä¾‹å¦‚ 20:05
				const t = timeToMin(cleanPart);
				if (!isNaN(t)) result.add(t);
			}
		});
		return Array.from(result);
	}

	function timeToMin(t) {
		// å…¼å®¹ä¸­æ–‡å†’å·å’Œè‹±æ–‡å†’å·
		const cleanT = t.replace(/ï¼š/g, ':');
		const parts = cleanT.split(':');
		if (parts.length !== 2) return NaN;
		const h = parseInt(parts[0]);
		const m = parseInt(parts[1]);
		if (isNaN(h) || isNaN(m) || h < 0 || h > 23 || m < 0 || m > 59) return NaN;
		return h * 60 + m;
	}

    function minToTime(m) {
        return `${Math.floor(m/60).toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}`;
    }

    init();
</script>
</body>
</html>
